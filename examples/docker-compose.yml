version: "3.8"

# AAS-ΔSync Demo Topology
# ========================
# Two independent "plant" deployments connected via MQTT
#
# Site A: basyx-aas-repo-a, basyx-sm-repo-a, agent-a
# Site B: basyx-aas-repo-b, basyx-sm-repo-b, agent-b
#
# Usage: docker compose up -d

services:
  # ============================================================================
  # MQTT Broker (shared between sites for simplicity)
  # ============================================================================
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: mosquitto
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf
    networks:
      - deltasync-net

  # ============================================================================
  # Site A: BaSyx AAS Stack
  # ============================================================================
  basyx-aas-repo-a:
    image: eclipsebasyx/aas-repository:2.0.0-milestone-03
    container_name: basyx-aas-repo-a
    ports:
      - "8081:8081"
    environment:
      - SERVER_PORT=8081
    volumes:
      - ./basyx/aas-repo-a.properties:/application/application.properties
    networks:
      - deltasync-net
    depends_on:
      - mosquitto

  basyx-sm-repo-a:
    image: eclipsebasyx/submodel-repository:2.0.0-milestone-03
    container_name: basyx-sm-repo-a
    ports:
      - "8082:8082"
    environment:
      - SERVER_PORT=8082
    volumes:
      - ./basyx/sm-repo-a.properties:/application/application.properties
    networks:
      - deltasync-net
    depends_on:
      - mosquitto

  # ============================================================================
  # Site B: BaSyx AAS Stack
  # ============================================================================
  basyx-aas-repo-b:
    image: eclipsebasyx/aas-repository:2.0.0-milestone-03
    container_name: basyx-aas-repo-b
    ports:
      - "8091:8091"
    environment:
      - SERVER_PORT=8091
    volumes:
      - ./basyx/aas-repo-b.properties:/application/application.properties
    networks:
      - deltasync-net
    depends_on:
      - mosquitto

  basyx-sm-repo-b:
    image: eclipsebasyx/submodel-repository:2.0.0-milestone-03
    container_name: basyx-sm-repo-b
    ports:
      - "8092:8092"
    environment:
      - SERVER_PORT=8092
    volumes:
      - ./basyx/sm-repo-b.properties:/application/application.properties
    networks:
      - deltasync-net
    depends_on:
      - mosquitto

  # ============================================================================
  # AAS-ΔSync Agents
  # ============================================================================
  # Note: Use locally built images or comment out until images are published
  # agent-a:
  #   image: ghcr.io/aeroshariati/aas-deltasync-agent:latest
  #   container_name: agent-a
  #   environment:
  #     - DELTASYNC_AGENT_ID=00000000-0000-0000-0000-00000000000a
  #     - DELTASYNC_ADAPTER_TYPE=basyx
  #     - DELTASYNC_SM_REPO_URL=http://basyx-sm-repo-a:8082
  #     - DELTASYNC_MQTT_BROKER=tcp://mosquitto:1883
  #     - DELTASYNC_TENANT=demo
  #     - DELTASYNC_DB_PATH=/data/agent-a.db
  #   volumes:
  #     - agent-a-data:/data
  #   networks:
  #     - deltasync-net
  #   depends_on:
  #     - basyx-sm-repo-a
  #     - mosquitto

  # agent-b:
  #   image: ghcr.io/aeroshariati/aas-deltasync-agent:latest
  #   container_name: agent-b
  #   environment:
  #     - DELTASYNC_AGENT_ID=00000000-0000-0000-0000-00000000000b
  #     - DELTASYNC_ADAPTER_TYPE=basyx
  #     - DELTASYNC_SM_REPO_URL=http://basyx-sm-repo-b:8092
  #     - DELTASYNC_MQTT_BROKER=tcp://mosquitto:1883
  #     - DELTASYNC_TENANT=demo
  #     - DELTASYNC_DB_PATH=/data/agent-b.db
  #   volumes:
  #     - agent-b-data:/data
  #   networks:
  #     - deltasync-net
  #   depends_on:
  #     - basyx-sm-repo-b
  #     - mosquitto

networks:
  deltasync-net:
    driver: bridge

volumes:
  agent-a-data:
  agent-b-data:
